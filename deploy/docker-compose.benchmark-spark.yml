version: '3.8'

# ============================================
# Spark ë²¤ì¹˜ë§ˆí¬ìš© Docker Compose
# 
# PostgreSQL ì§‘ê³„ vs Spark ì§‘ê³„ ì„±ëŠ¥ ë¹„êµ
#
# ì‹¤í–‰ ë°©ë²•:
#   cd deploy
#   docker-compose -f docker-compose.benchmark-spark.yml up --build
#
# ì •ë¦¬:
#   docker-compose -f docker-compose.benchmark-spark.yml down -v
# ============================================

services:
  # ============================================
  # ì¸í”„ë¼ ì„œë¹„ìŠ¤
  # ============================================

  postgres:
    image: postgres:15-alpine
    container_name: spark_benchmark_postgres
    restart: "no"
    environment:
      TZ: Asia/Seoul
      PGTZ: Asia/Seoul
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: sesac_db
    ports:
      - "5432:5432"
    volumes:
      - spark_benchmark_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 10

  # ============================================
  # ì´ˆê¸°í™” ì„œë¹„ìŠ¤
  # ============================================

  db-init:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: spark_benchmark_db_init
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      TZ: Asia/Seoul
      DB_TYPE: local
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: sesac_db
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
    command: >
      bash -c "
        echo 'â³ DB í…Œì´ë¸” ìƒì„± ì¤‘...';
        python -c 'from database.init_db import init_db; init_db()';
        echo 'âœ… DB ì´ˆê¸°í™” ì™„ë£Œ';
      "
    restart: "no"

  # ì´ˆê¸° ë°ì´í„° + ëŒ€ëŸ‰ ì£¼ë¬¸ ë°ì´í„° ìƒì„±
  data-seeder:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: spark_benchmark_data_seeder
    depends_on:
      db-init:
        condition: service_completed_successfully
    environment:
      TZ: Asia/Seoul
      DB_TYPE: local
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: sesac_db
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      KAFKA_ENABLED: "false"
    command: >
      bash -c "
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
        echo '        ğŸ“Š ë²¤ì¹˜ë§ˆí¬ìš© ë°ì´í„° ìƒì„± ì‹œì‘                       ';
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
        echo 'â³ ì´ˆê¸° ë°ì´í„° ìƒì„± ì¤‘ (ìœ ì € 2000ëª…, ìƒí’ˆ 5000ê°œ)...';
        python apps/seeders/initial_seeder.py --users 2000 --products 5000;
        echo 'âœ… ì´ˆê¸° ë°ì´í„° ìƒì„± ì™„ë£Œ';
        echo '';
        echo 'â³ ì£¼ë¬¸ ë°ì´í„° ëŒ€ëŸ‰ ìƒì„± ì¤‘ (50000ê±´)...';
        python -c \"
import sys
sys.path.insert(0, '/app')
from database import database, crud, models
from collect.order_generator import OrderGenerator
import random

db = database.SessionLocal()
users = [u[0] for u in db.query(models.User.id).limit(2000).all()]
products = [p[0] for p in db.query(models.Product.id).limit(5000).all()]

gen = OrderGenerator()
for i in range(50000):
    try:
        order = gen.generate_single(random.choice(users), random.choice(products))
        crud.create_order(db, order)
        if (i + 1) % 5000 == 0:
            print(f'  {i + 1}/50000 ì£¼ë¬¸ ìƒì„± ì™„ë£Œ')
    except Exception as e:
        db.rollback()
db.close()
print('âœ… ì£¼ë¬¸ 50000ê±´ ìƒì„± ì™„ë£Œ')
\";
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
        echo '        âœ… ë°ì´í„° ìƒì„± ì™„ë£Œ!                                ';
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
      "
    restart: "no"

  # ============================================
  # ë²¤ì¹˜ë§ˆí¬ ì„œë¹„ìŠ¤
  # ============================================

  # 1ë‹¨ê³„: PostgreSQL ì§‘ê³„ ë²¤ì¹˜ë§ˆí¬
  benchmark-sql:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: spark_benchmark_sql
    depends_on:
      data-seeder:
        condition: service_completed_successfully
    environment:
      TZ: Asia/Seoul
      DB_TYPE: local
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      POSTGRES_DB: sesac_db
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      BENCHMARK_ITERATIONS: 10
    volumes:
      - ../benchmark_results:/app/benchmark_results
    command: >
      bash -c "
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
        echo '        ğŸ—„ï¸ PostgreSQL ì§‘ê³„ ë²¤ì¹˜ë§ˆí¬ ì‹œì‘                    ';
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
        python apps/benchmarks/benchmark_sql_aggregation.py;
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
        echo '        âœ… PostgreSQL ì§‘ê³„ ë²¤ì¹˜ë§ˆí¬ ì™„ë£Œ                    ';
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
      "
    restart: "no"

  # 2ë‹¨ê³„: Spark ì§‘ê³„ ë²¤ì¹˜ë§ˆí¬
  benchmark-spark:
    image: apache/spark:3.5.0
    container_name: spark_benchmark_spark
    user: root
    depends_on:
      benchmark-sql:
        condition: service_completed_successfully
    volumes:
      - ..:/app
      - ../benchmark_results:/app/benchmark_results
    environment:
      TZ: Asia/Seoul
      PYTHONPATH: /app
      PYTHONUNBUFFERED: "1"
      POSTGRES_URL: jdbc:postgresql://postgres:5432/sesac_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: password
      BENCHMARK_ITERATIONS: 10
    command:
      - bash
      - -c
      - |
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
        echo '        âš¡ Spark ì§‘ê³„ ë²¤ì¹˜ë§ˆí¬ ì‹œì‘                         '
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
        /opt/spark/bin/spark-submit \
          --master local[*] \
          --packages org.postgresql:postgresql:42.6.0 \
          --conf spark.driver.extraJavaOptions=-Duser.timezone=Asia/Seoul \
          /app/apps/benchmarks/benchmark_spark_aggregation.py
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
        echo '        âœ… Spark ì§‘ê³„ ë²¤ì¹˜ë§ˆí¬ ì™„ë£Œ                         '
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•'
    restart: "no"

  # 3ë‹¨ê³„: ê²°ê³¼ ë¹„êµ ë¦¬í¬íŠ¸ ìƒì„±
  benchmark-report:
    build:
      context: ..
      dockerfile: deploy/Dockerfile
    container_name: spark_benchmark_report
    depends_on:
      benchmark-spark:
        condition: service_completed_successfully
    environment:
      TZ: Asia/Seoul
    volumes:
      - ../benchmark_results:/app/benchmark_results
    command: >
      bash -c "
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
        echo '        ğŸ“Š Spark vs PostgreSQL ë¹„êµ ë¦¬í¬íŠ¸ ìƒì„±             ';
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
        python apps/benchmarks/benchmark_spark_compare.py;
        echo '';
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
        echo '        âœ… ëª¨ë“  ë²¤ì¹˜ë§ˆí¬ ì™„ë£Œ!                              ';
        echo '        ğŸ“ ê²°ê³¼ íŒŒì¼: benchmark_results/ í´ë” í™•ì¸          ';
        echo 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•';
      "
    restart: "no"

volumes:
  spark_benchmark_postgres_data:
